<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Rajouter une fonction dans votre package</title>
    <meta charset="utf-8" />
    <meta name="author" content="Ma√´l THEULIERE - Juliette ENGELAERE-LEFEBVRE" />
    <meta name="date" content="2021-03-02" />
    <link href="libs/panelset/panelset.css" rel="stylesheet" />
    <script src="libs/panelset/panelset.js"></script>
    <script src="libs/clipboard/clipboard.min.js"></script>
    <link href="libs/shareon/shareon.min.css" rel="stylesheet" />
    <script src="libs/shareon/shareon.min.js"></script>
    <link href="libs/xaringanExtra-shareagain/shareagain.css" rel="stylesheet" />
    <script src="libs/xaringanExtra-shareagain/shareagain.js"></script>
    <link href="libs/tile-view/tile-view.css" rel="stylesheet" />
    <script src="libs/tile-view/tile-view.js"></script>
    <link href="libs/tachyons/tachyons.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Rajouter une fonction dans votre package
### Ma√´l THEULIERE - Juliette ENGELAERE-LEFEBVRE
### 2021-03-02

---
















# Qu'est ce qu'une fonction ?

Une fonction est un objet de R. C'est une op√©ration qui prend en entr√©e des arguments pour produire un r√©sultat.

Par exemple : 

- `abs()` prend comme argument un vecteur de nombre et produit un vecteur de nombre contenant la valeur absolue des nombres en argument.

- `select()` de `{dplyr}` prend comme argument un dataframe et une liste de colonne et produit en sortie un dataframe restreint √† ces colonnes.

- `write.csv()` prend en argument un dataframe, un lien vers un fichier et produit en sortie un fichier csv √† l'endroit sp√©cifi√© par le lien contenant le dataframe.
---
# D√©finir une fonction

Une fonction classique dans R se d√©finie de la sorte : 


```r
ma_fonction &lt;- function(a = 2,b = 1){
  resultat &lt;- a + 2*b
  return(resultat)
}
```

L'instruction `function()` cr√©er une fonction ici appel√©e `ma_function()`. 

Elle prend en argument les param√®tres de notre fonction, ici `a` et `b` auxquels ont peut assigner des valeurs par d√©faut, ici `1`. 

L'int√©rieur de nos accolades `{}` va d√©finir le r√©sultat produit par notre fonction. Ce r√©sultat doit √™tre retourn√© par l'instruction `return()`.

Voil√† comment se d√©fini une fonction type qui produit en retour un objet R. Certaines fonctions ne produisent pas des objets R mais des instructions, comme par exemple `write.csv()` vu pr√©c√©demment.


---

# Les bonnes pratiques

Pour cr√©er une bonne fonction, il faut bien penser sa coh√©rence dans le workflow dans lequelle elle va s'inscrire : 

- Pour faire telle op√©ration, dois je cr√©er une fonction ou deux car un r√©sultat interm√©diaire pourrait m'int√©resser ailleurs ? 

- Quels param√®tres ? 

- Quelle compl√©mentarit√© avec les fonctions existantes ?

- Quelle convention de nommage ?

Ensuite cette fonction devra √™tre correctement document√©e et test√©e. On verra dans la suite ce qu'est un test.

---
class: inverse, center, middle
# Rajouter une fonction dans votre package

---
#### Rajouter une fonction dans votre package

# cr√©er le fichier .R

.pull-left[
Pour rappel, le code d'une fonction doit √™tre rajout√© dans un script R du sous r√©pertoire `R/`.

Pour rajouter une fonction dans votre package, `{usethis}` vous facilite le travail :  `usethis::use_r("ma_fonction")` va cr√©er un fichier `ma_fonction.R` dans votre r√©pertoire `R/`.
]

.pull-right[
![](www/ma_fonction.png)
]
---
#### Rajouter une fonction dans votre package

# Rajouter votre fonction dans le fichier

.pull-left[
Ici on cr√©√© la fonction `ma_fonction` qui prend en param√®tres : 

- un dataframe `data`
- deux nombres `n_head` et `n_tail`

Et produit en sortie un dataframe compilant le d√©but et la fin du dataframe `data` en gardant `n_head` lignes du d√©but et `n_tail` lignes de la fin.

‚ö†Ô∏è Dans une fonction, il est commun d'utiliser des fonctions d'autres packages. Dans ce cas, appelez les en utilisant la convention `packages::fonction()`.
]

.pull-right[

```r
ma_fonction &lt;- function(data = NULL,
                        n_head = 3,
                        n_tail = 3){
  res &lt;- rbind(dplyr::slice_head(data,
                                 n = n_head),
               dplyr::slice_tail(data,
                                 n = n_tail)
  )
  return(res)
}
```

]

---

#### Rajouter une fonction dans votre package

# Utiliser votre fonction

`devtools::load_all()` vous permet de charger le contenu du package sur lequel vous travaillez comme ci vous l'aviez install√©. Dans votre workflow habituel, vous allez utiliser souvent cette fonction pour tester les fonctions que vous ajoutez.


```r
devtools::load_all()
```

Vous pouvez ensuite constater que votre fonction marche correctement üéâ


```r
ma_fonction(iris,2,3)
```

```
##   Sepal.Length Sepal.Width Petal.Length Petal.Width   Species
## 1          5.1         3.5          1.4         0.2    setosa
## 2          4.9         3.0          1.4         0.2    setosa
## 3          6.5         3.0          5.2         2.0 virginica
## 4          6.2         3.4          5.4         2.3 virginica
## 5          5.9         3.0          5.1         1.8 virginica
```

---
class: inverse, center, middle
# Documenter votre fonction
---
#### Documenter votre fonction
# {roxygen2}

Le package `{roxygen2}` va vous permettre de documenter votre fonction afin qu'une aide soit accessible pour celle ci.  

---
#### Documenter votre fonction

# {roxygen2} : cr√©er un caneva

.pull-left[
Pour ajouter une documentation, mettez le pointeur sur la fonction dans son script et utiliser le raccourci clavier `Ctrl + Alt + Shift + R` ou utiliser l'interface de Rstudio en cliquant sur `Code Tools`.
]

.pull-right[
![](www/ma_fonction_roxygen2.png)
]

---
#### Documenter votre fonction

# {roxygen2} : cr√©er un caneva

.pull-left[
Pour ajouter une documentation, mettez le pointeur sur la fonction dans son script et utiliser le raccourci clavier `Ctrl + Alt + Shift + R` ou utiliser l'interface de Rstudio en cliquant sur `Code Tools`.

Une fois activ√©, roxygen2 vous rajoute un caneva de documentation.
]

.pull-right[
![](www/ma_fonction_roxygen2_caneva.png)
]
---
#### Documenter votre fonction

# {roxygen2} : compl√©ter votre documentation

.pull-left[
Vous n'avez plus qu'√† compl√©ter üéâ! 
]
.pull-right[

```r
#' Garder les lignes de d√©but et de fin d'un dataframe
#'
#' @param data un dataframe
#' @param n_head le nombre de lignes √† garder du d√©but du fichier
#' @param n_tail le nombre de lignes √† garder de la fin du fichier
#'
#' @return un dataframe
#' @export
#'
#' @examples
#' ma_fonction(mpg,3,3)
ma_fonction &lt;- function(data = NULL,
                        n_head = 3,
                        n_tail = 3){
  res &lt;- rbind(dplyr::slice_head(data,n = n_head),
               dplyr::slice_tail(data,n = n_tail)
  )
  return(res)
}
```

]
---
#### Documenter votre fonction

# {roxygen2} : gestion des d√©pendances

.pull-left[
`{roxygen2}` permet non seulement de g√©rer la documentation mais aussi les d√©pendances et les exports de notre package. Cela se traduit par l'alimentation du fichier `NAMESPACE`.

La balise `@importFrom` permet de pr√©ciser les fonctions qu'on utilise dans le package. Cet ajout permettra de compl√©ter le fichier `NAMESPACE` avec les d√©pendances de notre package.

On ajoute une balise `@importFrom` pour chaque package utilis√©.

]
.pull-right[

```r
#' Garder les lignes de d√©but et de fin d'un dataframe
#'
#' @param data un dataframe
#' @param n_head le nombre de lignes √† garder du d√©but du fichier
#' @param n_tail le nombre de lignes √† garder de la fin du fichier
#'
#' @return un dataframe
#' @importFrom dplyr slice_head slice_tail
#' @export
#'
#' @examples
#' ma_fonction(mpg,3,3)
ma_fonction &lt;- function(data = NULL,
                        n_head = 3,
                        n_tail = 3){
  res &lt;- rbind(dplyr::slice_head(data,n = n_head),
               dplyr::slice_tail(data,n = n_tail)
  )
  return(res)
}
```

]
---
#### Documenter votre fonction

# {roxygen2} : gestion des exports

.pull-left[
La balise `@export` permet aussi de compl√©ter le fichier `NAMESPACE` en lui pr√©cisant cette fois ci que `ma_fonction()` est une fonction *export√©e* de `{monpackage}`. 

Si cette balise n'est pas ajout√©e, dans ce cas, la fonction restera purement interne au package. Cela est une convention utile pour d√©finir des fonctions n√©cessaires √† d'autres fonctions du package mais pas directement utiles pour les utilisateurs.

]
.pull-right[

```r
#' Garder les lignes de d√©but et de fin d'un dataframe
#'
#' @param data un dataframe
#' @param n_head le nombre de lignes √† garder du d√©but du fichier
#' @param n_tail le nombre de lignes √† garder de la fin du fichier
#'
#' @return un dataframe
#' @importFrom dplyr slice_head slice_tail
#' @export
#'
#' @examples
#' ma_fonction(mpg,3,3)
ma_fonction &lt;- function(data = NULL,
                        n_head = 3,
                        n_tail = 3){
  res &lt;- rbind(dplyr::slice_head(data,n = n_head),
               dplyr::slice_tail(data,n = n_tail)
  )
  return(res)
}
```

]
---
#### Documenter votre fonction

# {roxygen2} : document()

.pull-left[
Une fois votre documentation effectu√©e, la fonction `devtools::document()` va traduire ces balises en cr√©ant le fichier `ma_fonction.Rd` dans le r√©pertoire `man/` de documentation de votre fonction et en mettant √† jour le fichier NAMESPACE.

`devtools::check()` int√®gre `devtools::document()` donc vous aurez au d√©part rarement √† utiliser `devtools::document()` de fa√ßon isol√©e.
]
.pull-right[

```r
&gt; devtools::document()
Updating monpackage documentation
Loading monpackage
Writing NAMESPACE
Writing NAMESPACE
Writing ma_fonction.Rd
```

]


---
#### Documenter votre fonction

# {roxygen2} : document()

.pull-left[
Une fois votre documentation effectu√©e, la fonction `devtools::document()` va traduire ces balises en cr√©ant le fichier **`ma_fonction.Rd`** dans le r√©pertoire `man/` de documentation de votre fonction et en mettant √† jour le fichier NAMESPACE.

`devtools::check()` int√®gre `devtools::document()` donc vous aurez au d√©part rarement √† utiliser `devtools::document()` de fa√ßon isol√©e.
]
.pull-right[
![](www/ma_fonction_rd.png)
]
---
#### Documenter votre fonction

# {roxygen2} : document()

.pull-left[
Une fois votre documentation effectu√©e, la fonction `devtools::document()` va traduire ces balises en cr√©ant le fichier `ma_fonction.Rd` dans le r√©pertoire `man/` de documentation de votre fonction et en mettant √† jour le fichier **NAMESPACE**.

`devtools::check()` int√®gre `devtools::document()` donc vous aurez au d√©part rarement √† utiliser `devtools::document()` de fa√ßon isol√©e.
]
.pull-right[
![](www/namespace.png)
]


---
class : inverse, center, middle
# Tester votre fonction
---
#### Tester votre fonction
# Qu'est ce qu'un test ?

Une fois une fonction ajout√©e √† votre package, vous allez cr√©er un ou plusieurs tests la concernant.

Un test d√©fini un comportement attendu de votre fonction.

Par exemple, on s'attend √† ce que 2+2 soit √©gal √† 4. Plus g√©n√©ralement on s'attend √† ce qu'une addition renvoi un nombre.

Sur notre exemple de fonction, le r√©sultat de `ma_fonction()` doit √™tre un *dataframe*.

On va pouvoir √©crire un test qui cherche √† v√©rifier cela sur un exemple particulier.
---
#### Tester votre fonction
# Pourquoi faire un test ?

Les tests permettent de s√©curiser votre d√©veloppement. 

Imaginez sur notre exemple que la d√©finition de `slice_head()` et que par exemple le param√®tre `n` change de nom et devient `nb`.

Le fait d'avoir d√©fini un test pour s'assurer sur un jeu d'exemples du r√©sultats attendu vous permettra tr√®s vite d'identifier ce changement.
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
